# Description: NVIDIA Linux Display Driver (version 390)
# URL: https://www.nvidia.com
# Maintainer: Shinathip Duanghoy, shinathip.x2004 at gmail dot com
# Depends on: gtk libglvnd

name=nvidia390
version=390.154
release=1
source=(https://us.download.nvidia.com/XFree86/Linux-x86_64/$version/NVIDIA-Linux-x86_64-$version-no-compat32.run
        90-nvidia-uvm.rules)

build() {
    sh NVIDIA-Linux-x86_64-$version-no-compat32.run --extract-only
    cd NVIDIA-Linux-x86_64-$version-no-compat32

    # Library.
    install -d $PKG/usr/lib/{tls,vdpau}
    install libGL.so.$version               $PKG/usr/lib
    install libOpenCL.so.1.0.0              $PKG/usr/lib
    install libcuda.so.$version             $PKG/usr/lib
    install libnvcuvid.so.$version          $PKG/usr/lib
    install libnvidia-cfg.so.$version       $PKG/usr/lib
    install libnvidia-compiler.so.$version  $PKG/usr/lib
    install libnvidia-encode.so.$version    $PKG/usr/lib
    install libnvidia-fbc.so.$version       $PKG/usr/lib
    install libnvidia-glcore.so.$version    $PKG/usr/lib
    install libnvidia-ifr.so.$version       $PKG/usr/lib
    install libnvidia-ml.so.$version        $PKG/usr/lib
    install libnvidia-opencl.so.$version    $PKG/usr/lib
    install libnvidia-tls.so.$version       $PKG/usr/lib
    
    install tls/libnvidia-tls.so.$version   $PKG/usr/lib/tls
    install libvdpau_nvidia.so.$version     $PKG/usr/lib/vdpau

    ln -s libOpenCL.so.1.0.0                $PKG/usr/lib/libOpenCL.so
    ln -s libOpenCL.so.1.0.0                $PKG/usr/lib/libOpenCL.so.1
    ln -s libcuda.so.$version               $PKG/usr/lib/libcuda.so.1
    ln -s libnvcuvid.so.$version            $PKG/usr/lib/libnvcuvid.so
    ln -s libnvcuvid.so.$version            $PKG/usr/lib/libnvcuvid.so.1
    ln -s libnvidia-cfg.so.$version         $PKG/usr/lib/libnvidia-cfg.so.1
    ln -s libnvidia-encode.so.$version      $PKG/usr/lib/libnvidia-encode.so.1
    ln -s libnvidia-fbc.so.$version         $PKG/usr/lib/libnvidia-fbc.so.1
    ln -s libnvidia-ifr.so.$version         $PKG/usr/lib/libnvidia-ifr.so.1
    ln -s libnvidia-opencl.so.$version      $PKG/usr/lib/libnvidia-opencl.so.1
    ln -s libnvidia-ml.so.$version          $PKG/usr/lib/libnvidia-ml.so
    ln -s libnvidia-ml.so.$version          $PKG/usr/lib/libnvidia-ml.so.1
    ln -s libvdpau_nvidia.so.$version       $PKG/usr/lib/vdpau/libvdpau_nvidia.so
    ln -s libvdpau_nvidia.so.$version       $PKG/usr/lib/vdpau/libvdpau_nvidia.so.1

    # Xorg driver and extensions.
    install -d $PKG/usr/lib/xorg/modules/{drivers,extensions}
    install nvidia_drv.so $PKG/usr/lib/xorg/modules/drivers
    install libglx.so.$version $PKG/usr/lib/xorg/modules/extensions
    install libnvidia-wfb.so.$version $PKG/usr/lib/xorg/modules

    # Softwares and man pages.
    install -d $PKG/usr/{bin,share/man/man1}
    install nvidia-{debugdump,persistenced,settings,smi,xconfig}    $PKG/usr/bin
	install -m0644 nvidia-{persistenced,settings,smi,xconfig}.1.gz  $PKG/usr/share/man/man1

    # Desktop file and icons.
    install -d $PKG/usr/share/{applications,pixmaps}
    sed -i -e 's,__UTILS_PATH__,/usr/bin,' -e 's,__PIXMAP_PATH__,/usr/share/pixmaps,' nvidia-settings.desktop
    install -m 0644 nvidia-settings.desktop $PKG/usr/share/applications/
    install -m 0644 nvidia-settings.png     $PKG/usr/share/pixmaps/

    # Opencl ICD.
    install -Dm0644 nvidia.icd $PKG/etc/OpenCL/vendors/nvidia.icd

    # Nvidia-uvm module udev rule.
	install -Dm0644 $SRC/90-nvidia-uvm.rules $PKG/lib/udev/rules.d/90-nvidia-uvm.rules

    # nvidia-settings registry key file.
    install -d $PKG/usr/share/nvidia
    install -m0644 nvidia-application-profiles-$version-key-documentation $PKG/usr/share/nvidia

    # Kernel module
    (
        cd kernel
        IGNORE_CC_MISMATCH=1 make module
        install -d $PKG/lib/modules/$(uname -r)/extra
        install -m 0644 *.ko $PKG/lib/modules/$(uname -r)/extra/
    )

    # Blacklist nouveau module.
    echo "blacklist nouveau" | install -Dm644 /dev/stdin $PKG/etc/modprobe.d/nvidia-390xx.conf
}
